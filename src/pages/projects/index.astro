---
import Base from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';

export const prerender = true;

const projects = await getCollection('projects', ({ data }) => !data.draft);

// Sort: featured first, then by date descending
const sortedProjects = projects.sort((a, b) => {
  if (a.data.featured !== b.data.featured) {
    return a.data.featured ? -1 : 1;
  }
  return b.data.date.valueOf() - a.data.date.valueOf();
});

const base = import.meta.env.BASE_URL;

function getLatestActivity(project: typeof projects[0]) {
  const activities = project.data.activity;
  if (!activities || activities.length === 0) return null;
  return [...activities].sort((a, b) => b.date.valueOf() - a.date.valueOf())[0];
}

function formatRelativeDate(date: Date) {
  const msInDay = 1000 * 60 * 60 * 24;
  const days = Math.round((Date.now() - date.getTime()) / msInDay);

  if (days <= 0) return 'today';
  if (days === 1) return '1d ago';
  if (days < 7) return `${days}d ago`;

  const weeks = Math.round(days / 7);
  if (weeks < 5) return `${weeks}w ago`;

  const months = Math.round(days / 30);
  if (months < 12) return `${months}mo ago`;

  const years = Math.round(days / 365);
  return `${years}y ago`;
}
---

<Base title="Projects" description="Things I'm building and exploring">
  <main class="projects-page">
    <header class="page-header content-offset">
      <h1 class="page-title">Projects</h1>
      <p class="page-subtitle">Things I'm building and exploring.</p>
    </header>

    {sortedProjects.length === 0 ? (
      <p class="empty-state content-offset">No projects yet.</p>
    ) : (
      <ul class="projects-list" aria-label="Projects">
        {sortedProjects.map((project, index) => {
          const latestActivity = getLatestActivity(project);
          const latestDate = latestActivity?.date || project.data.date;
          const tags = project.data.tags?.slice(0, 3) || [];

          return (
            <li
              class="project-item reveal"
              style={`--reveal-delay: ${Math.min(index * 50, 300)}ms;`}
            >
              <article class="project-grid">
                <aside class="project-margin">
                  <p class="project-updated">
                    {formatRelativeDate(latestDate)}
                  </p>
                </aside>

                <div class="project-main">
                  <h2 class="project-title">
                    <a href={`${base}projects/${project.slug}/`}>
                      {project.data.title}
                    </a>
                  </h2>

                  <p class="project-description">{project.data.description}</p>

                  {latestActivity && (
                    <p class="latest-update">
                      <span class="latest-label">Latest:</span> {latestActivity.title}
                    </p>
                  )}

                  <p class="project-meta">
                    {project.data.github && (
                      <a href={project.data.github} target="_blank" rel="noopener" class="meta-link">
                        Code
                      </a>
                    )}
                    {project.data.github && project.data.live && (
                      <span class="meta-sep"> · </span>
                    )}
                    {project.data.live && (
                      <a href={project.data.live} target="_blank" rel="noopener" class="meta-link">
                        Live
                      </a>
                    )}
                    {(project.data.github || project.data.live) && tags.length > 0 && (
                      <span class="meta-sep"> · </span>
                    )}
                    {tags.length > 0 && (
                      <span class="project-tags">
                        {tags.map((tag, i) => (
                          <span>
                            #{tag}
                            {i < tags.length - 1 && ' '}
                          </span>
                        ))}
                      </span>
                    )}
                  </p>

                  <div class="project-separator" aria-hidden="true"></div>
                </div>
              </article>
            </li>
          );
        })}
      </ul>
    )}
  </main>

  <script>
    (() => {
      const entries = document.querySelectorAll('.reveal');
      if (!('IntersectionObserver' in window) || entries.length === 0) {
        entries.forEach(entry => entry.classList.add('visible'));
        return;
      }

      const observer = new IntersectionObserver((entryList) => {
        entryList.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.15 });

      entries.forEach(entry => observer.observe(entry));
    })();
  </script>
</Base>

<style>
  .projects-page {
    padding-top: clamp(0.1rem, 0.7vw, 0.42rem);
    padding-bottom: clamp(1.4rem, 2.8vw, 2.2rem);
  }

  .content-offset {
    padding-left: 0;
  }

  .page-header {
    margin-bottom: clamp(1.2rem, 2.4vw, 1.8rem);
  }

  .page-title {
    margin: 0 0 0.25rem 0;
    font-size: clamp(1.4rem, 2.5vw, 1.8rem);
    font-family: var(--entry-title-font);
    font-weight: 500;
    letter-spacing: -0.015em;
    color: var(--text-primary);
  }

  .page-subtitle {
    margin: 0;
    font-size: 0.82rem;
    color: var(--text-tertiary);
    letter-spacing: 0.012em;
  }

  .empty-state {
    color: var(--text-secondary);
    text-align: center;
    font-style: italic;
    padding: 2.2rem 0;
  }

  .projects-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .project-item {
    opacity: 0;
    transform: translateY(6px);
    transition: opacity 0.58s ease, transform 0.58s ease;
    transition-delay: var(--reveal-delay, 0ms);
    padding-bottom: clamp(1rem, 1.8vw, 1.45rem);
  }

  .project-item.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .project-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.72rem;
  }

  .project-margin {
    display: flex;
    align-items: baseline;
    color: var(--text-tertiary);
  }

  .project-updated {
    margin: 0;
    font-size: 0.78rem;
    color: var(--text-tertiary);
  }

  .project-main {
    min-width: 0;
  }

  .project-title {
    margin: 0 0 0.55rem 0;
    font-size: clamp(1.18rem, 2vw, 1.52rem);
    line-height: 1.22;
    font-family: var(--entry-title-font);
    font-weight: 500;
    letter-spacing: -0.012em;
  }

  .project-title a {
    color: var(--text-primary);
    text-decoration: none;
    border-bottom: 1px solid color-mix(in srgb, var(--text-tertiary) 40%, transparent);
    transition: border-color 0.2s ease, color 0.2s ease;
  }

  .project-title a:hover {
    color: var(--accent-hover);
    border-bottom-color: var(--accent);
  }

  .project-description {
    margin: 0 0 0.65rem 0;
    font-size: 1.02rem;
    line-height: 1.65;
    color: var(--text-secondary);
    max-width: 62ch;
  }

  .latest-update {
    margin: 0 0 0.85rem 0;
    font-size: 0.85rem;
    line-height: 1.5;
    color: var(--text-tertiary);
    max-width: 58ch;
  }

  .latest-label {
    color: var(--text-tertiary);
  }

  .project-meta {
    margin: 0 0 0.95rem 0;
    font-size: 0.8rem;
    color: var(--text-tertiary);
  }

  .meta-link {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    padding-bottom: 0.05rem;
  }

  .meta-link:hover {
    color: var(--accent-hover);
    border-bottom-color: var(--border-primary);
  }

  .meta-sep {
    color: var(--text-tertiary);
    opacity: 0.6;
  }

  .project-tags {
    color: var(--text-tertiary);
  }

  .project-separator {
    margin-top: clamp(2.2rem, 4.5vw, 3rem);
    width: 66%;
    border-top: 1px solid color-mix(in srgb, var(--border-primary) 40%, transparent);
  }

  .project-item:last-child .project-separator {
    display: none;
  }

  @media (min-width: 768px) {
    .content-offset {
      padding-left: 188px;
    }

    .project-grid {
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 3rem;
      align-items: start;
    }

    .project-margin {
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-end;
      text-align: right;
      padding-top: 0.3rem;
    }
  }
</style>
